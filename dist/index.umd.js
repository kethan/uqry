!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).uqry={})}(this,(function(e){const t=(e,r)=>{if(e===r)return!0;if(null==e||null==r||typeof e!=typeof r)return!1;if("object"==typeof e){if(Array.isArray(e)!==Array.isArray(r))return!1;const n=Object.keys(e),i=Object.keys(r);return n.length===i.length&&n.every((n=>t(e[n],r[n])))}return!1},r=e=>"object"==typeof e&&!Array.isArray(e),n=e=>"string"==typeof e&&e.startsWith("$"),i=(e,t)=>(Array.isArray(t)?t:t.split(".")).reduce(((e,t)=>e?e[t]:e),e),s={$eq:(e,r)=>t(e,r),$ne:(e,r)=>!t(e,r),$gt:(e,t)=>t>e,$gte:(e,t)=>t>=e,$lt:(e,t)=>t<e,$lte:(e,t)=>t<=e,$in:(e,t)=>t.some((t=>e.includes(t))),$nin:(e,t)=>!t.some((t=>e.includes(t))),$and:(e,t)=>e.every((e=>u(e)(t))),$or:(e,t)=>e.some((e=>u(e)(t))),$not:(e,t)=>!u(e)(t),$regex:(e,t)=>new RegExp(e).test(t)},c={$add:(e,t)=>e.map((e=>a(e)(t))).reduce(((e,t)=>e+t),0),$subtract:(e,t)=>e.map((e=>a(e)(t))).reduce(((e,t)=>e-t)),$multiply:(e,t)=>e.map((e=>a(e)(t))).reduce(((e,t)=>e*t),1),$divide:(e,t)=>e.map((e=>a(e)(t))).reduce(((e,t)=>e/t)),$concat:(e,t)=>e.map((e=>a(e)(t))).join(""),$min:(e,t)=>Math.min(...e.map((e=>a(e)(t)))),$max:(e,t)=>Math.max(...e.map((e=>a(e)(t)))),$avg:(e,t)=>e.map((e=>a(e)(t))).reduce(((e,t)=>e+t),0)/e.length,$sum:(e,t)=>e.map((e=>a(e)(t))).reduce(((e,t)=>e+t),0),$cond:([e,t,r],n)=>a(e)(n)?a(t)(n):a(r)(n),$eq:([e,r],n)=>t(a(e)(n),a(r)(n)),$ne:([e,r],n)=>!t(a(e)(n),a(r)(n)),$gt:([e,t],r)=>a(e)(r)>a(t)(r),$gte:([e,t],r)=>a(e)(r)>=a(t)(r),$lt:([e,t],r)=>a(e)(r)<a(t)(r),$lte:([e,t],r)=>a(e)(r)<=a(t)(r),$in:([e,t],r)=>a(t)(r).includes(a(e)(r)),$nin:([e,t],r)=>!a(t)(r).includes(a(e)(r)),$and:(e,t)=>e.every((e=>a(e)(t))),$or:(e,t)=>e.some((e=>a(e)(t))),$not:(e,t)=>!a(e[0])(t),$switch:(e,t)=>{const{branches:r,default:n}=e[0];for(const e of r)if(a(e.case)(t))return a(e.then)(t);return a(n)(t)}},o={$project:(e,t)=>{const s={};return Object.entries(e).forEach((([e,c])=>{1===c?s[e]=i(t,e):(n(c)||r(c))&&(s[e]=a(c)(t))})),s},$match:(e,t)=>u(e)(t)?t:null,$group:({_id:e,...t},r)=>{const n=r.reduce(((r,n)=>{const i=a(e)(n);return r[i]||(r[i]={_id:i}),Object.entries(t).forEach((([e,t])=>{r[i][e]||(r[i][e]=[]),r[i][e].push(a(t)(n))})),r}),{});return Object.values(n).map((e=>(Object.entries(e).forEach((([r,n])=>{if("_id"!==r){const[i,s]=Object.entries(t[r])[0];e[r]=c[i](n,{})}})),e)))},$sort:(e,t)=>{const[r,n]=Object.entries(e)[0];return t.sort(((e,t)=>i(e,r)>i(t,r)?n:-n))},$skip:(e,t)=>t.slice(e),$limit:(e,t)=>t.slice(0,e),$count:(e,t)=>[{[e]:t.length}]},u=e=>c=>r(e)?Object.entries(e).every((([e,t])=>n(e)?s[e](t,c):u(t)(i(c,e)))):t(c,e),a=e=>t=>{if(n(e))return i(t,e.slice(1));if(r(e)){const[r,n]=Object.entries(e)[0];if(c[r])return c[r](Array.isArray(n)?n:[n],t)}return e};e.add=(e,t)=>c[e]=t,e.aggregate=e=>t=>e.reduce(((e,t)=>{const[r,n]=Object.entries(t)[0];if(o[r])return["$group","$sort","$skip","$limit","$count"].includes(r)?o[r](n,e):e.map((e=>o[r](n,e))).filter(Boolean)}),t),e.expression=a,e.filter=u}));