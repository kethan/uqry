!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).uqry={})}(this,(function(e){const t=(e,r)=>{if(e===r)return!0;if(null==e||null==r||typeof e!=typeof r)return!1;if("object"==typeof e){if(Array.isArray(e)!==Array.isArray(r))return!1;const n=Object.keys(e),i=Object.keys(r);return n.length===i.length&&n.every((n=>t(e[n],r[n])))}return!1},r=e=>"object"==typeof e&&!Array.isArray(e),n=e=>"string"==typeof e&&e.startsWith("$"),i={$eq:(e,r)=>t(e,r),$ne:(e,r)=>!t(e,r),$gt:(e,t)=>t>e,$gte:(e,t)=>t>=e,$lt:(e,t)=>t<e,$lte:(e,t)=>t<=e,$in:(e,t)=>t.some((t=>e.includes(t))),$nin:(e,t)=>!t.some((t=>e.includes(t))),$and:(e,t)=>e.every((e=>c(e)(t))),$or:(e,t)=>e.some((e=>c(e)(t))),$not:(e,t)=>!c(e)(t)},s={$add:(e,t)=>e.map((e=>u(e)(t))).reduce(((e,t)=>e+t),0),$subtract:(e,t)=>e.map((e=>u(e)(t))).reduce(((e,t)=>e-t)),$multiply:(e,t)=>e.map((e=>u(e)(t))).reduce(((e,t)=>e*t),1),$divide:(e,t)=>e.map((e=>u(e)(t))).reduce(((e,t)=>e/t)),$concat:(e,t)=>e.map((e=>u(e)(t))).join(""),$min:(e,t)=>Math.min(...e.map((e=>u(e)(t)))),$max:(e,t)=>Math.max(...e.map((e=>u(e)(t)))),$avg:(e,t)=>e.map((e=>u(e)(t))).reduce(((e,t)=>e+t),0)/e.length,$sum:(e,t)=>e.map((e=>u(e)(t))).reduce(((e,t)=>e+t),0),$cond:([e,t,r],n)=>u(e)(n)?u(t)(n):u(r)(n),$eq:([e,r],n)=>t(u(e)(n),u(r)(n)),$ne:([e,r],n)=>!t(u(e)(n),u(r)(n)),$gt:([e,t],r)=>u(e)(r)>u(t)(r),$gte:([e,t],r)=>u(e)(r)>=u(t)(r),$lt:([e,t],r)=>u(e)(r)<u(t)(r),$lte:([e,t],r)=>u(e)(r)<=u(t)(r),$in:([e,t],r)=>u(t)(r).includes(u(e)(r)),$nin:([e,t],r)=>!u(t)(r).includes(u(e)(r)),$and:(e,t)=>e.every((e=>u(e)(t))),$or:(e,t)=>e.some((e=>u(e)(t))),$not:(e,t)=>!u(e[0])(t)},o={$project:(e,t)=>{const i={};return Object.entries(e).forEach((([e,s])=>{1===s?i[e]=t[e]:(n(s)||r(s))&&(i[e]=u(s)(t))})),i},$match:(e,t)=>c(e)(t)?t:null,$group:({_id:e,...t},r)=>{const n=r.reduce(((r,n)=>{const i=u(e)(n);return r[i]||(r[i]={_id:i}),Object.entries(t).forEach((([e,t])=>{r[i][e]||(r[i][e]=[]),r[i][e].push(u(t)(n))})),r}),{});return Object.values(n).map((e=>(Object.entries(e).forEach((([t,r])=>{"_id"!==t&&(e[t]=s.$sum(r,{}))})),e)))},$sort:(e,t)=>{const[r,n]=Object.entries(e)[0];return t.sort(((e,t)=>e[r]>t[r]?n:-n))},$skip:(e,t)=>t.slice(e),$limit:(e,t)=>t.slice(0,e),$count:(e,t)=>[{[e]:t.length}]},c=e=>s=>r(e)?Object.entries(e).every((([e,t])=>n(e)?i[e](t,s):c(t)(s?.[e]))):t(s,e),u=e=>t=>{if(n(e))return t[e.slice(1)];if(r(e)){const[r,n]=Object.entries(e)[0];if(s[r])return s[r](Array.isArray(n)?n:[n],t)}return e};e.add=(e,t)=>s[e]=t,e.aggregate=e=>t=>e.reduce(((e,t)=>{const[r,n]=Object.entries(t)[0];if(o[r])return["$group","$sort","$skip","$limit","$count"].includes(r)?o[r](n,e):e.map((e=>o[r](n,e))).filter(Boolean)}),t),e.expression=u,e.filter=c}));